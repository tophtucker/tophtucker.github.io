<!DOCTYPE html>
<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Toph Tucker</title>

<style>

body {
  font-size: 14px;
  max-width: 20em;
  margin: 1em auto;
}
h1, h2, h3 {
  font-weight: normal;
}


.underlying {
  opacity: 0;
  pointer-events: none;
}

.overlay {
  position: absolute;
  top: 0;
  left: 0;
}

.overlay span {
  position: absolute;
}

svg {
  position: absolute;
  z-index: -1;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
}

@media screen and (min-width: 320px) {
  body {
    font-size: calc(14px + 8 * ((100vw - 320px) / 960));
  }
}
@media screen and (min-width: 1280px) {
  body {
    font-size: 22px;
  }
}

</style>

<body>
  
  <div class="underlying"></div>

  <div class="overlay"></div>

  <svg></svg>

  <template id="home">
    <h1>Toph Tucker</h1>
    <p>
      Web programmer at Kensho, formerly Businessweek. 
      <a href="https://twitter.com/tophtucker/">Twitter</a>, 
      <a href="https://github.com/tophtucker">GitHub</a>, 
      <a href="http://bl.ocks.org/tophtucker">bl.ocks</a>,
      <a href="https://medium.com/@tophtucker/">Medium</a>,
      tophtucker@gmail.com
    </p>
  </template>

</body>

<script src="d3.v4.js"></script>
<script src='improvedNoise.js'></script>
<script src='forces.js'></script>
<script src='projects.js'></script>
<script>

var mouse = [-100,-100];
d3.select('html').on('mousemove', function() {
  mouse = d3.mouse(this);
})

var letterSim = d3.forceSimulation()
  .alphaDecay(0)
  .force("x", d3.forceX(function(d) { return d.x1; }).strength(.05))
  .force("y", d3.forceY(function(d) { return d.y1; }).strength(.05))
  .force("motion", forceMotion())
  .force("noise", forceNoise());

handleNav();
window.addEventListener("hashchange", handleNav, false);

function split(container) {
  if(!container.childNodes.length) {
    var letters = container.textContent.split('');
    return letters.map(function(d) { return '<span class="ltr">' + d + '</span>'; }).join('');
  } else {
    var html = '';
    for(var i = 0; i < container.childNodes.length; i++) {
      html += split(container.childNodes[i]);
    }
    container.innerHTML = html;
    return container.outerHTML;
  }
}

function computePositions(container) {

  // compute positions and styles of letters as rendered
  d3.select(container).selectAll('span.ltr')
    .datum(function(d,i) {
      var styles = window.getComputedStyle(this);
      return {
        letter: this.textContent,
        index: i,
        char: this.textContent.charCodeAt(0),
        x1: this.offsetLeft,
        y1: this.offsetTop,
        fontSize: styles['font-size'],
        fontWeight: styles['font-weight'],
        fontStyle: styles['font-style'],
        color: styles['color']
      }
    });

  // attach links to children spans 
  // (since they'll be disassociated from the dom tree)
  d3.select(container).selectAll('a').each(function() {
    var href = this.attributes.href.value;
    d3.select(this).selectAll('span.ltr')
      .each(function(d) {
        d.href = href;
      })
  });

  var data = d3.select(container).selectAll('span.ltr').data();

  // for every letter, find it's the nth letter of its kind
  var nester = d3.nest().key(function(d) { return d.char; });
  var data = d3.merge(nester.entries(data).map(function(d) { 
    return d.values.map(function(dd, ii) { 
      dd.charI = ii;
      dd.key = d.key + '-' + ii;
      return dd;
    }); 
  })).sort(function(a,b) {
    return a.index - b.index;
  });

  return data;
}

function render(data) {

  var letters = d3.select('.overlay')
    .selectAll('span')
    .data(data, function(d) { return d.key; })
    .each(function(d) {
      if(!d.x) d.x = parseFloat(d3.select(this).style('left'));
      if(!d.y) d.y = parseFloat(d3.select(this).style('top'));
    });

  letters.exit()
    .each(function(d) {
      var r = Math.sqrt(Math.pow(innerWidth,2) + Math.pow(innerHeight,2)) / 2;
      var theta = Math.random() * 2 * Math.PI;
      d.x1 = (innerWidth/2 + r * Math.cos(theta));
      d.y1 = (innerHeight/2 + r * Math.sin(theta));
    })
    .transition()
    .duration(1000)
    .style('left', function(d) { return d.x1 + 'px'; })
    .style('top', function(d) { return d.y1 + 'px'; })
    .remove();

  letters = letters.enter().append('span')
    .text(function(d) { return d.letter; })
    .text(function(d) { return d.letter; })
    .each(function(d) {
      var r = Math.sqrt(Math.pow(innerWidth,2) + Math.pow(innerHeight,2)) / 2;
      var theta = Math.random() * 2 * Math.PI;
      d.x = (innerWidth/2 + r * Math.cos(theta));
      d.y = (innerHeight/2 + r * Math.sin(theta));
    })
    .style('left', function(d) { return d.x0 + 'px'; })
    .style('top', function(d) { return d.y0 + 'px'; })
  .merge(letters)
    .style('cursor', function(d) { return d.href ? 'pointer' : 'default'; })
    .on('click', function(d) {
      if(d.href) window.location = d.href;
    });

  letters.transition()
    .duration(1000)
    .style('font-size', function(d) { return d.fontSize; })
    .style('font-weight', function(d) { return d.fontWeight; })
    .style('font-style', function(d) { return d.fontStyle; })
    .style('color', function(d) { return d.color; })

  letterSim
    .nodes(letters.data())
    .on('tick', function() {
      letters
        .style('left', function(d) { return d.x + 'px'; })
        .style('top', function(d) { return d.y + 'px'; });
    });

}


function renderHome(container) {
  container.html(document.querySelector('#home').innerHTML);
  container.selectAll('h2.project')
    .data(projects)
    .enter()
    .append('h2')
    .classed('project', true)
    .append('a')
    .attr('href', function(d) { return '#' + d.slug; })
    .text(function(d) { return d.title; });
}

function renderProject(container, slug) {
  var project = projects.filter(function(d) { return d.slug === slug; })[0];

  container.html('');
  container.append('h1')
    .append('a')
    .attr('href', '#')
    .text('Toph Tucker');

  container.append('h2').text(project.title);
  container.append('p').html(project.date);
  container.append('p').html(project.byline);
  container.append('a').attr('href', project.url).text(project.url);
  container.append('p').html(project.description);
}

function handleNav() {
  if(window.location.hash === '' || window.location.hash === '#') {
    renderHome(d3.select('.underlying'));
  } else {
    renderProject(d3.select('.underlying'), window.location.hash.split('#')[1]);
  }

  d3.select('.underlying')
    .each(function() {
      split(this);
      render(computePositions(this));
    });
}

////////////////////////////////
///// BACKGROUND PARTICLES /////
////////////////////////////////

var particleSim = d3.forceSimulation()
  .alphaDecay(0)
  .force("noise", forceNoise().strength(.1).random(1))
  .force("torus", forceTorus())
  .force("mortality", forceMortality());

function renderParticles() {

  var particles = d3.range(50).map(function(d) {
    return {
      x: Math.random() * innerWidth,
      y: Math.random() * innerHeight,
      vx: 0,
      vy: 0,
      r: 1,
      color: '#999'
    }
  });

  var particle = d3.select('svg').selectAll('circle')
    .data(particles)
    .enter()
    .append('circle')
    .style('fill', function(d) { return d.color; })
    .attr('r', function(d) { return d.r; });

  particleSim
    .nodes(particles)
    .on('tick', function() {
      particle
        .attr('cx', function(d) { return d.x; })
        .attr('cy', function(d) { return d.y; })
        .attr('r', function(d) { return d.r; });
    });
}

renderParticles();

</script>

</html>